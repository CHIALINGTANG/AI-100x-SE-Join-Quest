<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>訂單優惠模組 BDD 與重構報告</title>
  <style>
    body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; margin: 2rem; line-height: 1.6; }
    h1 { color: #2c3e50; }
    h2 { color: #34495e; margin-top: 2rem; }
    ul { padding-left: 1.5rem; }
    table { border-collapse: collapse; margin-top: 1rem; width: 100%; max-width: 760px; }
    th, td { border: 1px solid #d0d7de; padding: 0.5rem 0.75rem; text-align: left; vertical-align: top; }
    th { background-color: #f6f8fa; }
    code { background-color: #f6f8fa; padding: 0.1rem 0.4rem; border-radius: 3px; }
    footer { margin-top: 3rem; font-size: 0.9rem; color: #6c757d; }
  </style>
</head>
<body>
  <h1>訂單優惠模組 BDD 與重構報告</h1>

  <section>
    <h2>BDD 開發流程回顧</h2>
    <p>依 <code>BDD.prompt</code> 與 <code>1111.feature</code> 的指引，逐一完成以下步驟：</p>
    <ul>
      <li>初始化 Cucumber walking skeleton，確認測試框架可以執行。</li>
      <li>每次僅啟用一個 Scenario，先觀察失敗訊息後再補齊步驟與實作，維持「先紅後綠」的節奏。</li>
      <li>所有 Scenario 全數解鎖後再執行一次測試，確保優惠邏輯的堆疊與順序正確。</li>
    </ul>
  </section>

  <section>
    <h2>程式對應清單</h2>
    <p>主要驗收情境與程式位置對照如下：</p>
    <table>
      <thead>
        <tr>
          <th>驗收情境</th>
          <th>主要程式位置</th>
          <th>行為說明</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>order.feature + 1111.feature</td><td>OrderService.checkout, PromotionContext, BuyOneGetOneCosmeticsRule, ElevenElevenQuantityDiscountRule, ThresholdDiscountRule</td><td>整合計算原始金額、出貨明細與優惠堆疊；順序由 PromotionRule#getOrder 控制。</td></tr>
      </tbody>
    </table>
    <p>新設計透過 <code>PromotionRule</code> 介面與 <code>PromotionContext</code> 封裝折扣行為；新增規則僅需實作並呼叫 <code>registerPromotion</code> 即可擴充。</p>
  </section>

  <section>
    <h2>重構設計重點</h2>
    <ul>
      <li><code>OrderService</code> 僅負責註冊與排序促銷規則，遵守 OCP。</li>
      <li><code>PromotionContext</code> 追蹤原始金額、當前小計與最終出貨列表，避免規則間互相覆寫資料。</li>
      <li>各促銷（BOGO、11/11、門檻折扣）透過 <code>PromotionRule#getOrder</code> 定義執行順序，確保堆疊結果一致。</li>
    </ul>
  </section>

  <section>
    <h2>測試結果</h2>
    <table>
      <thead>
        <tr>
          <th>指令</th>
          <th>輸出摘要</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>mvn -Dcucumber.plugin=html:target/cucumber-report.html test</code></td>
          <td>Tests run: 14, Failures: 0, Errors: 0, Skipped: 0</td>
        </tr>
      </tbody>
    </table>
  </section>

  <footer>
    <p>報告生成時間：2025-10-03 11:08:30</p>
  </footer>
</body>
</html>